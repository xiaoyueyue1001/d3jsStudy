<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <script src="./lib/d3js/d3.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
        }

        div.tip-hill-div {
            background: rgba(0, 0, 0, 0.7);
            color: #fff;
            padding: 10px;
            border-radius: 5px;
            font-family: Microsoft Yahei;
        }

        div.tip-hill-div>h1 {
            font-size: 14px;
        }

        div.tip-hill-div>h2 {
            font-size: 12px;
        }
    </style>
</head>

<body>
    <div id="chart"></div>
    <script>
        var data = [{
            "letter": "白皮鸡蛋",
            "child": {
                "category": "0",
                "value": "459.00"
            }
        }, {
            "letter": "红皮鸡蛋",
            "child": {
                "category": "0",
                "value": "389.00"
            }
        }, {
            "letter": "鸡蛋",
            "child": {
                "category": "0",
                "value": "336.00"
            }
        }, {
            "letter": "牛肉",
            "child": {
                "category": "0",
                "value": "282.00"
            }
        }, {
            "letter": "羊肉",
            "child": {
                "category": "0",
                "value": "249.00"
            }
        }, {
            "letter": "鸭蛋",
            "child": {
                "category": "0",
                "value": "242.00"
            }
        }, {
            "letter": "红薯",
            "child": {
                "category": "0",
                "value": "222.00"
            }
        }, {
            "letter": "白菜",
            "child": {
                "category": "0",
                "value": "182.00"
            }
        }, {
            "letter": "鸡肉",
            "child": {
                "category": "0",
                "value": "102.00"
            }
        }];

        var margin = {
            top: 20,
            right: 50,
            bottom: 50,
            left: 90
        };

        var svgWidth = 1000;
        var svgHeight = 300;


        //创建各个面的颜色数组
        var mainColorList = ['#f6e242', '#ebec5b', '#d2ef5f', '#b1d894', '#97d5ad', '#82d1c0', '#70cfd2', '#63c8ce', '#50bab8', '#38a99d'];
        var topColorList = ['#e9d748', '#d1d252', '#c0d75f', '#a2d37d', '#83d09e', '#68ccb6', '#5bc8cb', '#59c0c6', '#3aadab', '#2da094'];
        var rightColorList = ['#dfce51', '#d9db59', '#b9d54a', '#9ece7c', '#8ac69f', '#70c3b1', '#65c5c8', '#57bac0', '#42aba9', '#2c9b8f'];

        var svg = d3.select('#chart')
            .append('svg')
            .attr('width', svgWidth)
            .attr('height', svgHeight)
            .attr('id', 'svg-column');


        //创建X轴序数比例尺
        function addXAxis() {
            var transform = d3.geoTransform({
                point: function (x, y) {
                    this.stream.point(x, y)
                }
            });
            //定义几何路径
            var path = d3.geoPath()
                .projection(transform);

            xLinearScale = d3.scaleBand()
                .domain(data.map(function (d) {
                    return d.letter;
                }))
                .range([0, svgWidth - margin.right - margin.left]);
            var xAxis = d3.axisBottom(xLinearScale)
                .ticks(data.length);
            //绘制X轴
            var xAxisG = svg.append("g")
                .call(xAxis)
                .attr("transform", "translate(" + (margin.left) + "," + (svgHeight - margin.bottom) + ")");

            //删除原X轴
            xAxisG.select("path").remove();
            xAxisG.selectAll('line').remove();
            //绘制新的立体X轴
            xAxisG.append("path")
                .datum({
                    type: "Polygon",
                    coordinates: [
                        [
                            [20, 0],
                            [0, 15],
                            [svgWidth - margin.right - margin.left, 15],
                            [svgWidth + 20 - margin.right - margin.left, 0],
                            [20, 0]
                        ]
                    ]
                })
                .attr("d", path)
                .attr('fill', 'rgb(187,187,187)');
            xAxisG.selectAll('text')
                .attr('font-size', '18px')
                .attr('fill', '#646464')
                .attr('transform', 'translate(0,20)');

            dataProcessing(xLinearScale)//核心算法
        }
        addXAxis()
        //创建Y轴线性比例尺
        var yLinearScale;
        //创建y轴的比例尺渲染y轴
        function addYScale() {
            yLinearScale = d3.scaleLinear()
                .domain([0, d3.max(data, function (d, i) {
                    return d.child.value * 1;
                }) * 1.2])
                .range([svgHeight - margin.top - margin.bottom, 0]);

            //定义Y轴比例尺以及刻度
            var yAxis = d3.axisLeft(yLinearScale)
                .ticks(6);

            //绘制Y轴
            var yAxisG = svg.append("g")
                .call(yAxis)
                .attr('transform', 'translate(' + (margin.left + 10) + "," + margin.top + ")");
            yAxisG.selectAll('text')
                .attr('font-size', '18px')
                .attr('fill', '#636363');
            //删除原Y轴路径和tick
            yAxisG.select("path").remove();
            yAxisG.selectAll('line').remove();
        }
        addYScale()
        //核心算法思路是Big boss教的,我借花献佛
        function dataProcessing(xLinearScale) {
            var angle = Math.PI / 2.3;
            for (var i = 0; i < data.length; i++) {
                var d = data[i];
                var depth = 10;
                d.ow = xLinearScale.bandwidth() * 0.7;
                d.ox = xLinearScale(d.letter);
                d.oh = 1;
                d.p1 = {
                    x: Math.cos(angle) * d.ow,
                    y: -Math.sin(angle) - depth
                };
                d.p2 = {
                    x: d.p1.x + d.ow,
                    y: d.p1.y
                };
                d.p3 = {
                    x: d.p2.x,
                    y: d.p2.y + d.oh
                };
            }
        }

        function addColumn() {
            function clumnMouseover(d) {
                d3.select(this).selectAll(".transparentPath").attr("opacity", 0.8);
            }

            function clumnMouseout(d) {
                d3.select(this).selectAll(".transparentPath").attr("opacity", 1);
            }

            var g = svg.selectAll('.g')
                .data(data)
                .enter()
                .append('g')
                .on("mouseover", clumnMouseover)
                .on("mouseout", clumnMouseout)
                .attr('transform', function (d) {
                    return "translate(" + (d.ox + margin.left + 20) + "," + (svgHeight - margin.bottom + 15) + ")"
                });
            g.transition()
                .duration(2500)
                .attr("transform", function (d) {
                    return "translate(" + (d.ox + margin.left + 20) + ", " + (yLinearScale(d.child.value) + margin.bottom - 15) + ")"
                });

            g.append('rect')
                .attr('x', 0)
                .attr('y', 0)
                .attr("class", "transparentPath")
                .attr('width', function (d, i) {
                    return d.ow;
                })
                .attr('height', function (d) {
                    return d.oh;
                })
                .style('fill', function (d, i) {
                    return mainColorList[i]
                })
                .transition()
                .duration(2500)
                .attr("height", function (d, i) {
                    return svgHeight - margin.bottom - margin.top - yLinearScale(d.child.value);
                });

            g.append('path')
                .attr("class", "transparentPath")
                .attr('d', function (d) {
                    return "M0,0 L" + d.p1.x + "," + d.p1.y + " L" + d.p2.x + "," + d.p2.y + " L" + d.ow + ",0 L0,0";
                })
                .style('fill', function (d, i) {
                    return topColorList[i]
                });

            g.append('path')
                .attr("class", "transparentPath")
                .attr('d', function (d) {
                    return "M" + d.ow + ",0 L" + d.p2.x + "," + d.p2.y + " L" + d.p3.x + "," + d.p3.y + " L" + d.ow + "," + d.oh + " L" + d.ow + ",0"
                })
                .style('fill', function (d, i) {
                    return rightColorList[i]
                })
                .transition()
                .duration(2500)
                .attr("d", function (d, i) {
                    return "M" + d.ow + ",0 L" + d.p2.x + "," + d.p2.y + " L" + d.p3.x + "," + (d.p3.y + svgHeight - margin.top - margin.bottom - yLinearScale(d.child.value)) + " L" + d.ow + "," + (svgHeight - margin.top - margin.bottom - yLinearScale(d.child.value)) + " L" + d.ow + ",0"
                });
        }

        addColumn()
    </script>
</body>

</html>